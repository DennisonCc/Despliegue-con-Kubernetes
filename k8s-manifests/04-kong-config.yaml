apiVersion: batch/v1
kind: Job
metadata:
  name: kong-config-job
  namespace: integration-ns
spec:
  template:
    metadata:
      labels:
        app: kong-config
    spec:
      restartPolicy: OnFailure
      containers:
      - name: kong-config
        image: curlimages/curl:latest
        command: ["/bin/sh"]
        args:
          - "-c"
          - |
            set -e
            echo "Esperando a que Kong esté listo..."
            until curl -s http://kong-admin-svc:8001/status > /dev/null; do
              echo "Esperando Kong Admin API..."
              sleep 5
            done
            echo "Kong está listo. Configurando servicios..."
            
            # Configurar servicio zone-core
            curl -i -X POST http://kong-admin-svc:8001/services/ \
              --data "name=zone-core" \
              --data "url=http://zone-core-svc:8080"
            
            curl -i -X POST http://kong-admin-svc:8001/services/zone-core/routes \
              --data "name=zone-core-route" \
              --data "paths[]=/zone" \
              --data "strip_path=false"
            
            # Configurar servicio mc-clientes
            curl -i -X POST http://kong-admin-svc:8001/services/ \
              --data "name=mc-clientes" \
              --data "url=http://mc-clientes-svc:8081"
            
            curl -i -X POST http://kong-admin-svc:8001/services/mc-clientes/routes \
              --data "name=mc-clientes-route" \
              --data "paths[]=/clientes" \
              --data "strip_path=false"
            
            # Configurar servicio ms-tickets
            curl -i -X POST http://kong-admin-svc:8001/services/ \
              --data "name=ms-tickets" \
              --data "url=http://ms-tickets-svc:4000"
            
            curl -i -X POST http://kong-admin-svc:8001/services/ms-tickets/routes \
              --data "name=ms-tickets-route" \
              --data "paths[]=/tickets" \
              --data "strip_path=false"
            
            # Configurar servicio notification-service
            curl -i -X POST http://kong-admin-svc:8001/services/ \
              --data "name=notification-service" \
              --data "url=http://notification-svc:3001"
            
            curl -i -X POST http://kong-admin-svc:8001/services/notification-service/routes \
              --data "name=notification-route" \
              --data "paths[]=/notifications" \
              --data "strip_path=false"
            
            echo "Configuración de Kong completada!"
